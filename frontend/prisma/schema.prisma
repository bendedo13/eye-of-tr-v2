generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  Int            @id @default(autoincrement())
  email               String         @unique(map: "ix_users_email") @db.VarChar(255)
  username            String         @unique(map: "ix_users_username") @db.VarChar(50)
  hashed_password     String         @db.VarChar(255)
  tier                String         @default("free") @db.VarChar(20)
  credits             Int            @default(1)
  is_active           Boolean        @default(true)
  role                String         @default("user") @db.VarChar(20)
  referral_code       String         @unique(map: "ix_users_referral_code") @db.VarChar(10)
  referred_by         String?        @db.VarChar(10)
  referral_count      Int            @default(0)
  total_searches      Int            @default(0)
  successful_searches Int            @default(0)
  created_at          DateTime?      @default(now()) @db.Timestamptz(6)
  updated_at          DateTime?      @updatedAt @db.Timestamptz(6)
  last_search_at      DateTime?      @db.Timestamptz(6)
  
  // Relations
  payments            Payment[]
  referral_logs_ref   ReferralLog[]  @relation("referral_logs_ref_user")
  referral_logs_rec   ReferralLog[]  @relation("referral_logs_rec_user")
  search_logs         SearchLog[]
  subscriptions       Subscription[]
  searches            Search[]
  dork_searches       DorkSearch[]
  dork_limit          DorkLimit?

  @@map("users")
  @@index([id], map: "ix_users_id")
}

model Search {
  id        String   @id @default(cuid())
  userId    Int
  imageUrl  String
  results   Json?
  createdAt DateTime @default(now())
  status    String   @default("completed")
  user      User     @relation(fields: [userId], references: [id])
}

model DorkSearch {
  id        String   @id @default(cuid())
  userId    Int
  query     String
  dorkType  String
  results   Json?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model DorkLimit {
  id     String   @id @default(cuid())
  userId Int      @unique
  date   DateTime @default(now())
  count  Int      @default(0)
  user   User     @relation(fields: [userId], references: [id])
}

model Payment {
  id             Int       @id @default(autoincrement())
  user_id        Int
  amount         Float
  currency       String    @db.VarChar(10)
  plan_name      String    @db.VarChar(50)
  status         String    @db.VarChar(20)
  payment_method String?   @db.VarChar(50)
  transaction_id String?   @unique @db.VarChar(255)
  created_at     DateTime? @default(now()) @db.Timestamptz(6)
  completed_at   DateTime? @db.Timestamptz(6)
  user           User      @relation(fields: [user_id], references: [id])

  @@map("payments")
  @@index([id], map: "ix_payments_id")
}

model Subscription {
  id         Int       @id @default(autoincrement())
  user_id    Int
  plan_name  String    @db.VarChar(50)
  plan_price Float
  is_active  Boolean
  auto_renew Boolean
  start_date DateTime? @default(now()) @db.Timestamptz(6)
  end_date   DateTime? @db.Timestamptz(6)
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  user       User      @relation(fields: [user_id], references: [id])

  @@map("subscriptions")
  @@index([id], map: "ix_subscriptions_id")
}

model SearchLog {
  id                 Int       @id @default(autoincrement())
  user_id            Int?
  search_type        String    @db.VarChar(50)
  query              String?   @db.VarChar(255)
  file_name          String?   @db.VarChar(255)
  results_found      Int
  is_successful      Boolean
  providers_used     String?   @db.VarChar(255)
  search_duration_ms Int?
  credits_used       Int
  was_blurred        Boolean
  created_at         DateTime? @default(now()) @db.Timestamptz(6)
  user               User?     @relation(fields: [user_id], references: [id])

  @@map("search_logs")
  @@index([id], map: "ix_search_logs_id")
}

model ReferralLog {
  id               Int       @id @default(autoincrement())
  referrer_user_id Int
  referrer_code    String    @db.VarChar(10)
  referee_user_id  Int
  referee_email    String    @db.VarChar(255)
  reward_given     Boolean
  credits_awarded  Int
  created_at       DateTime? @default(now()) @db.Timestamptz(6)
  referrer         User      @relation("referral_logs_ref_user", fields: [referrer_user_id], references: [id])
  referee          User      @relation("referral_logs_rec_user", fields: [referee_user_id], references: [id])

  @@map("referral_logs")
  @@index([id], map: "ix_referral_logs_id")
}

model SiteVisit {
  id         Int       @id @default(autoincrement())
  ip_address String?   @db.VarChar(45)
  user_agent String?   @db.VarChar(255)
  country    String?   @db.VarChar(100)
  page_url   String?   @db.VarChar(255)
  referrer   String?   @db.VarChar(255)
  visited_at DateTime? @default(now()) @db.Timestamptz(6)

  @@map("site_visits")
  @@index([id], map: "ix_site_visits_id")
}

model Admin {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())
}

model SiteSettings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  updatedAt DateTime @updatedAt
}

model PricingPlan {
  id             String   @id @default(cuid())
  name           Json
  price          Float
  credits        Int
  features       Json
  isPopular      Boolean  @default(false)
  isActive       Boolean  @default(true)
  sortOrder      Int      @default(0)
  lemonSqueezyId String?
  updatedAt      DateTime @updatedAt
}
